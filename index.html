<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>PO Request</title>
<link rel="manifest" href="manifest.json">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,500;0,9..40,700;1,9..40,400&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<style>
  :root {
    --bg: #0F1114;
    --surface: #1A1D23;
    --surface-2: #22262E;
    --surface-3: #2A2F38;
    --border: #2E3440;
    --border-focus: #5E81AC;
    --text: #ECEFF4;
    --text-dim: #8892A2;
    --text-muted: #5C6370;
    --accent: #88C0D0;
    --accent-dim: rgba(136,192,208,0.12);
    --green: #A3BE8C;
    --green-dim: rgba(163,190,140,0.12);
    --red: #BF616A;
    --red-dim: rgba(191,97,106,0.12);
    --yellow: #EBCB8B;
    --yellow-dim: rgba(235,203,139,0.12);
    --orange: #D08770;
    --radius: 12px;
    --radius-sm: 8px;
    --shadow: 0 2px 12px rgba(0,0,0,0.3);
    --font: 'DM Sans', sans-serif;
    --mono: 'JetBrains Mono', monospace;
    --safe-bottom: env(safe-area-inset-bottom, 0px);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: var(--font);
    background: var(--bg);
    color: var(--text);
    min-height: 100dvh;
    -webkit-font-smoothing: antialiased;
    overflow-x: hidden;
  }

  /* ‚îÄ‚îÄ LOGIN SCREEN ‚îÄ‚îÄ */
  .login-screen {
    min-height: 100dvh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 24px;
    background: radial-gradient(ellipse at 50% 0%, rgba(136,192,208,0.06) 0%, transparent 60%);
  }

  .login-logo {
    width: 64px; height: 64px;
    background: linear-gradient(135deg, var(--accent), #5E81AC);
    border-radius: 18px;
    display: flex; align-items: center; justify-content: center;
    font-size: 28px; font-weight: 700;
    margin-bottom: 16px;
    box-shadow: 0 4px 24px rgba(136,192,208,0.2);
  }

  .login-title {
    font-size: 22px; font-weight: 700;
    margin-bottom: 4px;
  }

  .login-sub {
    color: var(--text-dim);
    font-size: 14px;
    margin-bottom: 32px;
  }

  .login-form {
    width: 100%; max-width: 360px;
  }

  .field {
    margin-bottom: 16px;
  }

  .field label {
    display: block;
    font-size: 12px;
    font-weight: 500;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.8px;
    margin-bottom: 6px;
  }

  .field input, .field select, .field textarea {
    width: 100%;
    padding: 12px 14px;
    background: var(--surface);
    border: 1.5px solid var(--border);
    border-radius: var(--radius-sm);
    color: var(--text);
    font-family: var(--font);
    font-size: 15px;
    transition: border-color 0.2s;
    outline: none;
  }

  .field input:focus, .field select:focus, .field textarea:focus {
    border-color: var(--border-focus);
  }

  .field input::placeholder { color: var(--text-muted); }

  .btn {
    width: 100%;
    padding: 13px;
    border: none;
    border-radius: var(--radius-sm);
    font-family: var(--font);
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.15s;
    display: flex; align-items: center; justify-content: center; gap: 8px;
  }

  .btn-primary {
    background: var(--accent);
    color: var(--bg);
  }
  .btn-primary:active { transform: scale(0.98); opacity: 0.9; }

  .btn-secondary {
    background: var(--surface-2);
    color: var(--text);
    border: 1.5px solid var(--border);
  }

  .btn-sm {
    width: auto;
    padding: 8px 16px;
    font-size: 13px;
  }

  .btn-danger {
    background: var(--red-dim);
    color: var(--red);
    border: 1.5px solid transparent;
  }

  .btn-approve {
    background: var(--green-dim);
    color: var(--green);
    border: 1.5px solid transparent;
  }

  .btn-reject {
    background: var(--red-dim);
    color: var(--red);
    border: 1.5px solid transparent;
  }

  .login-error {
    background: var(--red-dim);
    color: var(--red);
    padding: 10px 14px;
    border-radius: var(--radius-sm);
    font-size: 13px;
    margin-bottom: 16px;
    display: none;
  }

  .login-toggle {
    text-align: center;
    margin-top: 20px;
    font-size: 13px;
    color: var(--text-dim);
  }

  .login-toggle a {
    color: var(--accent);
    cursor: pointer;
    text-decoration: none;
  }

  /* ‚îÄ‚îÄ APP SHELL ‚îÄ‚îÄ */
  .app { display: none; flex-direction: column; min-height: 100dvh; }
  .app.active { display: flex; }
  .login-screen.hidden { display: none; }

  /* Top bar */
  .topbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 16px;
    padding-top: max(12px, env(safe-area-inset-top));
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    position: sticky; top: 0; z-index: 100;
  }

  .topbar-left {
    display: flex; align-items: center; gap: 10px;
  }

  .topbar-logo {
    width: 34px; height: 34px;
    background: linear-gradient(135deg, var(--accent), #5E81AC);
    border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    font-size: 16px; font-weight: 700;
  }

  .topbar-title {
    font-size: 16px; font-weight: 700;
  }

  .topbar-user {
    display: flex; align-items: center; gap: 8px;
    font-size: 13px; color: var(--text-dim);
  }

  .topbar-user .role-badge {
    font-size: 10px;
    padding: 2px 7px;
    background: var(--accent-dim);
    color: var(--accent);
    border-radius: 20px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .logout-btn {
    background: none; border: none; color: var(--text-muted);
    cursor: pointer; font-size: 18px; padding: 4px 8px;
  }

  /* Content area */
  .content {
    flex: 1;
    overflow-y: auto;
    padding-bottom: calc(72px + var(--safe-bottom));
  }

  /* Bottom nav */
  .bottom-nav {
    position: fixed;
    bottom: 0; left: 0; right: 0;
    display: flex;
    background: var(--surface);
    border-top: 1px solid var(--border);
    padding-bottom: var(--safe-bottom);
    z-index: 100;
  }

  .nav-item {
    flex: 1;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    padding: 10px 0;
    color: var(--text-muted);
    font-size: 10px;
    font-weight: 500;
    cursor: pointer;
    transition: color 0.2s;
    text-decoration: none;
    position: relative;
    -webkit-tap-highlight-color: transparent;
  }

  .nav-item.active {
    color: var(--accent);
  }

  .nav-item svg {
    width: 22px; height: 22px;
    margin-bottom: 3px;
  }

  .nav-badge {
    position: absolute;
    top: 4px; right: calc(50% - 18px);
    background: var(--red);
    color: #fff;
    font-size: 10px;
    font-weight: 700;
    min-width: 16px;
    height: 16px;
    border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    padding: 0 4px;
  }

  /* ‚îÄ‚îÄ PAGES ‚îÄ‚îÄ */
  .page { display: none; }
  .page.active { display: block; }

  .page-header {
    padding: 20px 16px 12px;
  }

  .page-title {
    font-size: 24px;
    font-weight: 700;
  }

  .page-subtitle {
    font-size: 13px;
    color: var(--text-dim);
    margin-top: 2px;
  }

  /* ‚îÄ‚îÄ NEW PO FORM ‚îÄ‚îÄ */
  .form-section {
    padding: 0 16px;
    margin-bottom: 20px;
  }

  .section-title {
    font-size: 13px;
    font-weight: 600;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.8px;
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--border);
  }

  .line-item {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 14px;
    margin-bottom: 10px;
    position: relative;
    animation: slideIn 0.2s ease;
  }

  @keyframes slideIn {
    from { opacity: 0; transform: translateY(-8px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .line-item .field { margin-bottom: 10px; }
  .line-item .field:last-child { margin-bottom: 0; }

  .line-item-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
  }

  .line-item-num {
    font-family: var(--mono);
    font-size: 12px;
    color: var(--accent);
    font-weight: 600;
  }

  .remove-item {
    background: none; border: none;
    color: var(--text-muted);
    cursor: pointer;
    font-size: 18px;
    padding: 2px 6px;
    border-radius: 6px;
    transition: all 0.15s;
  }

  .remove-item:hover { color: var(--red); background: var(--red-dim); }

  .cost-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }

  .add-item-btn {
    width: 100%;
    padding: 12px;
    border: 1.5px dashed var(--border);
    border-radius: var(--radius);
    background: transparent;
    color: var(--accent);
    font-family: var(--font);
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center; gap: 6px;
    transition: all 0.15s;
  }

  .add-item-btn:active { background: var(--accent-dim); }

  .total-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 14px 16px;
    margin: 0 16px;
    background: var(--surface-2);
    border-radius: var(--radius);
    margin-bottom: 16px;
  }

  .total-label { font-size: 14px; color: var(--text-dim); }

  .total-amount {
    font-family: var(--mono);
    font-size: 20px;
    font-weight: 700;
    color: var(--accent);
  }

  .submit-area {
    padding: 0 16px 24px;
  }

  /* ‚îÄ‚îÄ PO LIST ‚îÄ‚îÄ */
  .po-card {
    margin: 0 16px 10px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 14px;
    cursor: pointer;
    transition: all 0.15s;
  }

  .po-card:active { background: var(--surface-2); }

  .po-card-top {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 8px;
  }

  .po-id {
    font-family: var(--mono);
    font-size: 13px;
    color: var(--accent);
    font-weight: 600;
  }

  .po-card .po-id.has-po-number {
    color: var(--green);
  }

  .po-status {
    font-size: 11px;
    font-weight: 600;
    padding: 3px 10px;
    border-radius: 20px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .status-requested { background: var(--yellow-dim); color: var(--yellow); }
  .status-approved { background: var(--green-dim); color: var(--green); }
  .status-rejected { background: var(--red-dim); color: var(--red); }

  /* ‚îÄ‚îÄ PROCESS FLOW STEPPER ‚îÄ‚îÄ */
  .process-flow {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    padding: 20px 8px 8px;
    position: relative;
    margin-bottom: 4px;
  }

  .process-flow::before {
    content: '';
    position: absolute;
    top: 36px;
    left: calc(16.66% + 12px);
    right: calc(16.66% + 12px);
    height: 3px;
    background: var(--border);
    border-radius: 2px;
    z-index: 0;
  }

  .process-step {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    flex: 1;
    position: relative;
    z-index: 1;
  }

  .step-circle {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 13px;
    font-weight: 700;
    border: 2.5px solid var(--border);
    background: var(--bg);
    color: var(--text-muted);
    transition: all 0.3s ease;
  }

  .step-label {
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-muted);
    transition: color 0.3s ease;
  }

  .step-date {
    font-size: 10px;
    color: var(--text-muted);
    font-family: var(--mono);
    margin-top: -4px;
  }

  /* Active step: requested */
  .process-step.step-active .step-circle {
    border-color: var(--yellow);
    background: var(--yellow-dim);
    color: var(--yellow);
  }
  .process-step.step-active .step-label {
    color: var(--yellow);
  }

  /* Completed step */
  .process-step.step-done .step-circle {
    border-color: var(--green);
    background: var(--green-dim);
    color: var(--green);
  }
  .process-step.step-done .step-label {
    color: var(--green);
  }

  /* Rejected step */
  .process-step.step-rejected .step-circle {
    border-color: var(--red);
    background: var(--red-dim);
    color: var(--red);
  }
  .process-step.step-rejected .step-label {
    color: var(--red);
  }

  /* Progress line between steps */
  .process-flow.flow-approved::before {
    background: linear-gradient(90deg, var(--green) 0%, var(--green) 100%);
  }
  .process-flow.flow-rejected::before {
    background: linear-gradient(90deg, var(--yellow) 0%, var(--red) 100%);
  }
  .process-flow.flow-requested::before {
    background: linear-gradient(90deg, var(--yellow) 0%, var(--border) 50%);
  }

  .po-vendor {
    font-size: 15px;
    font-weight: 600;
    margin-bottom: 4px;
  }

  .po-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 12px;
    color: var(--text-dim);
  }

  .po-total {
    font-family: var(--mono);
    font-weight: 600;
    color: var(--text);
  }

  .filter-bar {
    display: flex;
    gap: 8px;
    padding: 0 16px 12px;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }

  .filter-btn {
    padding: 6px 14px;
    border-radius: 20px;
    border: 1.5px solid var(--border);
    background: transparent;
    color: var(--text-dim);
    font-family: var(--font);
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    white-space: nowrap;
    transition: all 0.15s;
    -webkit-tap-highlight-color: transparent;
  }

  .filter-btn.active {
    background: var(--accent-dim);
    border-color: var(--accent);
    color: var(--accent);
  }

  /* ‚îÄ‚îÄ PO DETAIL MODAL ‚îÄ‚îÄ */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    backdrop-filter: blur(4px);
    z-index: 200;
    display: none;
    align-items: flex-end;
    justify-content: center;
  }

  .modal-overlay.active { display: flex; }

  .modal {
    background: var(--surface);
    border-radius: 20px 20px 0 0;
    width: 100%;
    max-width: 480px;
    max-height: 85dvh;
    overflow-y: auto;
    padding: 20px 16px calc(20px + var(--safe-bottom));
    animation: slideUp 0.25s ease;
  }

  @keyframes slideUp {
    from { transform: translateY(100%); }
    to { transform: translateY(0); }
  }

  .modal-handle {
    width: 36px; height: 4px;
    background: var(--text-muted);
    border-radius: 4px;
    margin: 0 auto 16px;
  }

  .modal-title {
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 4px;
  }

  .detail-section {
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid var(--border);
  }

  .detail-row {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    font-size: 14px;
  }

  .detail-label { color: var(--text-dim); }
  .detail-value { font-weight: 500; text-align: right; }

  .detail-item {
    background: var(--surface-2);
    border-radius: var(--radius-sm);
    padding: 10px 12px;
    margin-bottom: 8px;
  }

  .detail-item-name {
    font-size: 14px;
    font-weight: 500;
    margin-bottom: 2px;
  }

  .detail-item-meta {
    font-size: 12px;
    color: var(--text-dim);
    display: flex;
    justify-content: space-between;
  }

  .approval-actions {
    display: flex; gap: 10px;
    margin-top: 16px;
  }

  .approval-actions .btn { flex: 1; }

  .approver-toolbar {
    display: flex;
    gap: 8px;
    justify-content: flex-end;
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid var(--border);
  }

  .approver-toolbar .btn {
    width: auto;
    padding: 8px 16px;
    font-size: 13px;
  }

  .btn-edit {
    background: var(--accent-dim);
    color: var(--accent);
    border: 1.5px solid transparent;
  }

  .btn-delete {
    background: var(--red-dim);
    color: var(--red);
    border: 1.5px solid transparent;
  }

  /* Edit form inside modal */
  .edit-form .field {
    margin-bottom: 12px;
  }

  .edit-form .field input,
  .edit-form .field textarea {
    background: var(--surface-2);
  }

  .edit-line-item {
    background: var(--surface-2);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 12px;
    margin-bottom: 8px;
  }

  .edit-line-item .cost-row {
    margin-top: 8px;
  }

  .edit-actions {
    display: flex;
    gap: 10px;
    margin-top: 16px;
  }

  .edit-actions .btn { flex: 1; }

  .confirm-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    backdrop-filter: blur(6px);
    z-index: 300;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 24px;
  }

  .confirm-overlay.active { display: flex; }

  .confirm-dialog {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 24px;
    max-width: 340px;
    width: 100%;
    text-align: center;
    animation: slideIn 0.2s ease;
  }

  .confirm-title {
    font-size: 17px;
    font-weight: 700;
    margin-bottom: 8px;
  }

  .confirm-text {
    font-size: 14px;
    color: var(--text-dim);
    margin-bottom: 20px;
    line-height: 1.5;
  }

  .confirm-actions {
    display: flex;
    gap: 10px;
  }

  .confirm-actions .btn { flex: 1; }

  /* ‚îÄ‚îÄ PENDING APPROVAL SCREEN ‚îÄ‚îÄ */
  .pending-screen {
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100dvh;
    padding: 32px 24px;
    text-align: center;
    background: radial-gradient(ellipse at 50% 30%, rgba(235,203,139,0.05) 0%, transparent 60%);
  }

  .pending-screen.active { display: flex; }

  .pending-icon {
    width: 72px; height: 72px;
    background: var(--yellow-dim);
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 32px;
    margin-bottom: 20px;
  }

  .pending-title {
    font-size: 20px;
    font-weight: 700;
    margin-bottom: 8px;
  }

  .pending-text {
    font-size: 14px;
    color: var(--text-dim);
    line-height: 1.6;
    max-width: 320px;
    margin-bottom: 24px;
  }

  .pending-email {
    font-family: var(--mono);
    font-size: 13px;
    color: var(--accent);
    background: var(--accent-dim);
    padding: 6px 14px;
    border-radius: 20px;
    margin-bottom: 24px;
  }

  /* ‚îÄ‚îÄ USER MANAGEMENT ‚îÄ‚îÄ */
  .user-card {
    margin: 0 16px 10px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 14px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
  }

  .user-info {
    flex: 1;
    min-width: 0;
  }

  .user-name {
    font-size: 15px;
    font-weight: 600;
    margin-bottom: 2px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .user-email {
    font-size: 12px;
    color: var(--text-dim);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .user-badges {
    display: flex;
    gap: 6px;
    margin-top: 4px;
  }

  .badge-approved {
    font-size: 10px;
    padding: 2px 7px;
    background: var(--green-dim);
    color: var(--green);
    border-radius: 20px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .badge-pending-approval {
    font-size: 10px;
    padding: 2px 7px;
    background: var(--yellow-dim);
    color: var(--yellow);
    border-radius: 20px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .badge-role {
    font-size: 10px;
    padding: 2px 7px;
    background: var(--accent-dim);
    color: var(--accent);
    border-radius: 20px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .user-actions {
    display: flex;
    gap: 6px;
    flex-shrink: 0;
  }

  .user-actions .btn {
    width: auto;
    padding: 7px 12px;
    font-size: 12px;
  }

  .user-filter-bar {
    display: flex;
    gap: 8px;
    padding: 0 16px 12px;
    overflow-x: auto;
  }

  .empty-state {
    text-align: center;
    padding: 60px 24px;
    color: var(--text-dim);
  }

  .empty-icon {
    font-size: 48px;
    margin-bottom: 12px;
    opacity: 0.4;
  }

  .empty-text {
    font-size: 15px;
    font-weight: 500;
    margin-bottom: 4px;
    color: var(--text);
  }

  .empty-sub { font-size: 13px; }

  .toast {
    position: fixed;
    top: 20px;
    left: 50%; transform: translateX(-50%);
    background: var(--surface-2);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 12px 20px;
    border-radius: var(--radius);
    font-size: 14px;
    font-weight: 500;
    z-index: 300;
    box-shadow: var(--shadow);
    animation: toastIn 0.3s ease;
    display: none;
  }

  .toast.success { border-color: var(--green); }
  .toast.error { border-color: var(--red); }

  @keyframes toastIn {
    from { opacity: 0; transform: translateX(-50%) translateY(-12px); }
    to { opacity: 1; transform: translateX(-50%) translateY(0); }
  }

  .loading {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 40px;
  }

  .spinner {
    width: 28px; height: 28px;
    border: 3px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.7s linear infinite;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  .config-banner {
    background: var(--yellow-dim);
    color: var(--yellow);
    padding: 12px 16px;
    font-size: 13px;
    text-align: center;
    font-weight: 500;
  }

  .field textarea {
    resize: vertical;
    min-height: 70px;
  }

  .requester-info {
    font-size: 12px;
    color: var(--text-dim);
    margin-top: -4px;
  }

  select option {
    background: var(--surface);
    color: var(--text);
  }
</style>
</head>
<body>

<div id="toast" class="toast"></div>

<!-- ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ -->
<div id="loginScreen" class="login-screen">
  <div class="login-logo">PO</div>
  <div class="login-title">Purchase Orders</div>
  <div class="login-sub">Sign in to continue</div>
  <div class="login-form">
    <div id="loginError" class="login-error"></div>
    <div class="field">
      <label>Email</label>
      <input type="email" id="loginEmail" placeholder="you@company.com" autocomplete="email">
    </div>
    <div class="field" id="nameField" style="display:none">
      <label>Full Name</label>
      <input type="text" id="signupName" placeholder="Jane Smith">
    </div>
    <div class="field">
      <label>Password</label>
      <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
    </div>
    <button class="btn btn-primary" id="loginBtn" onclick="handleAuth()">Sign In</button>
    <div class="login-toggle">
      <span id="toggleText">Don't have an account?</span>
      <a id="toggleLink" href="javascript:void(0)" onclick="toggleAuthMode()">Sign Up</a>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ PENDING APPROVAL ‚îÄ‚îÄ -->
<div id="pendingScreen" class="pending-screen">
  <div class="pending-icon">‚è≥</div>
  <div class="pending-title">Account Pending Approval</div>
  <div class="pending-text">Your account has been created but needs to be approved by an administrator before you can submit purchase orders.</div>
  <div class="pending-email" id="pendingEmail"></div>
  <button class="btn btn-secondary btn-sm" onclick="logout()" style="width:auto;padding:10px 24px">Sign Out</button>
</div>

<!-- ‚îÄ‚îÄ APP ‚îÄ‚îÄ -->
<div id="app" class="app">
  <div class="topbar">
    <div class="topbar-left">
      <div class="topbar-logo">PO</div>
      <div class="topbar-title">Purchase Orders</div>
    </div>
    <div class="topbar-user">
      <span id="userRole" class="role-badge"></span>
      <button class="logout-btn" onclick="logout()" title="Sign out">‚èª</button>
    </div>
  </div>

  <div class="content">
    <!-- New PO Page -->
    <div id="pageNew" class="page active">
      <div class="page-header">
        <div class="page-title">New Request</div>
        <div class="page-subtitle">Submit a purchase order for approval</div>
      </div>

      <div class="form-section">
        <div class="section-title">Vendor Information</div>
        <div class="field">
          <label>Vendor / Supplier Name</label>
          <input type="text" id="vendorName" placeholder="e.g. Acme Supplies Inc.">
        </div>
        <div class="field">
          <label>For (Vehicle / Tractor / Shop)</label>
          <input type="text" id="poFor" placeholder="e.g. 2019 John Deere 8R, Shop #3, Truck 12">
        </div>
        <div class="field">
          <label>Notes (optional)</label>
          <textarea id="poNotes" placeholder="Any additional details..."></textarea>
        </div>
      </div>

      <div class="form-section">
        <div class="section-title">Line Items</div>
        <div id="lineItems"></div>
        <button class="add-item-btn" onclick="addLineItem()">
          <span style="font-size:18px">+</span> Add Item
        </button>
      </div>

      <div class="total-bar">
        <span class="total-label">Estimated Total</span>
        <span id="totalAmount" class="total-amount">$0.00</span>
      </div>

      <div class="submit-area">
        <button class="btn btn-primary" onclick="submitPO()">Submit Request</button>
      </div>
    </div>

    <!-- My POs Page -->
    <div id="pageMyPOs" class="page">
      <div class="page-header">
        <div class="page-title">My Requests</div>
        <div class="page-subtitle">Track your purchase orders</div>
      </div>
      <div class="filter-bar">
        <button class="filter-btn active" onclick="filterPOs('all', this)">All</button>
        <button class="filter-btn" onclick="filterPOs('requested', this)">Requested</button>
        <button class="filter-btn" onclick="filterPOs('approved', this)">Approved</button>
        <button class="filter-btn" onclick="filterPOs('rejected', this)">Rejected</button>
      </div>
      <div id="myPOList"></div>
    </div>

    <!-- Approvals Page (approvers only) -->
    <div id="pageApprovals" class="page">
      <div class="page-header">
        <div class="page-title">Approvals</div>
        <div class="page-subtitle">Review pending purchase orders</div>
      </div>
      <div class="filter-bar">
        <button class="filter-btn active" onclick="filterApprovals('requested', this)">Requested</button>
        <button class="filter-btn" onclick="filterApprovals('all', this)">All</button>
      </div>
      <div id="approvalList"></div>
    </div>

    <!-- Users Page (approvers only) -->
    <div id="pageUsers" class="page">
      <div class="page-header">
        <div class="page-title">Users</div>
        <div class="page-subtitle">Manage employee accounts</div>
      </div>
      <div class="user-filter-bar">
        <button class="filter-btn active" onclick="filterUsers('pending', this)">Pending</button>
        <button class="filter-btn" onclick="filterUsers('approved', this)">Approved</button>
        <button class="filter-btn" onclick="filterUsers('all', this)">All</button>
      </div>
      <div id="userList"></div>
    </div>
  </div>

  <!-- Bottom Nav -->
  <nav class="bottom-nav">
    <a class="nav-item active" onclick="showPage('pageNew', this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="18" x2="12" y2="12"/><line x1="9" y1="15" x2="15" y2="15"/></svg>
      <span>New</span>
    </a>
    <a class="nav-item" onclick="showPage('pageMyPOs', this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
      <span>My POs</span>
    </a>
    <a id="navApprovals" class="nav-item" onclick="showPage('pageApprovals', this)" style="display:none">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
      <span>Approvals</span>
      <span id="approvalBadge" class="nav-badge" style="display:none">0</span>
    </a>
    <a id="navUsers" class="nav-item" onclick="showPage('pageUsers', this)" style="display:none">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
      <span>Users</span>
      <span id="usersBadge" class="nav-badge" style="display:none">0</span>
    </a>
  </nav>
</div>

<!-- PO Detail Modal -->
<div id="detailModal" class="modal-overlay" onclick="if(event.target===this)closeModal()">
  <div class="modal">
    <div class="modal-handle"></div>
    <div id="modalContent"></div>
  </div>
</div>

<!-- Delete Confirmation -->
<div id="confirmOverlay" class="confirm-overlay" onclick="if(event.target===this)closeConfirm()">
  <div class="confirm-dialog">
    <div class="confirm-title">Delete Purchase Order?</div>
    <div class="confirm-text" id="confirmText">This action cannot be undone. The PO and all its data will be permanently removed.</div>
    <div class="confirm-actions">
      <button class="btn btn-secondary" onclick="closeConfirm()">Cancel</button>
      <button class="btn btn-delete" id="confirmDeleteBtn" onclick="confirmDeletePO()">Delete</button>
    </div>
  </div>
</div>

<script>
// ‚îÄ‚îÄ‚îÄ CONFIG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Replace these with your Supabase project values
const SUPABASE_URL = 'https://ndzlvuvceraprpjhseax.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5kemx2dXZjZXJhcHJwamhzZWF4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzMTMwMzQsImV4cCI6MjA4NTg4OTAzNH0.fQk-lXcBFxSRY1wTFwr1v7katWT-dscvcWMLXv7lteI';

let sb, currentUser, currentProfile, isSignUp = false;

function initSupabase() {
  if (SUPABASE_URL === 'YOUR_SUPABASE_URL') {
    showToast('Configure Supabase credentials in index.html', 'error');
    return false;
  }
  if (typeof window.supabase === 'undefined') {
    showToast('Supabase library failed to load. Check your connection.', 'error');
    return false;
  }
  if (!sb) {
    sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  }
  return true;
}

// ‚îÄ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleAuthMode() {
  isSignUp = !isSignUp;
  document.getElementById('nameField').style.display = isSignUp ? 'block' : 'none';
  document.getElementById('loginBtn').textContent = isSignUp ? 'Create Account' : 'Sign In';
  document.getElementById('toggleText').textContent = isSignUp ? 'Already have an account?' : "Don't have an account?";
  document.getElementById('toggleLink').textContent = isSignUp ? 'Sign In' : 'Sign Up';
  document.getElementById('loginError').style.display = 'none';
}

async function handleAuth() {
  if (!initSupabase()) return;
  const email = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPassword').value;
  const errEl = document.getElementById('loginError');

  if (!email || !password) {
    errEl.textContent = 'Please enter email and password';
    errEl.style.display = 'block';
    return;
  }

  const btn = document.getElementById('loginBtn');
  btn.disabled = true;
  btn.textContent = isSignUp ? 'Creating...' : 'Signing in...';

  try {
    let result;
    if (isSignUp) {
      const name = document.getElementById('signupName').value.trim();
      if (!name) {
        errEl.textContent = 'Please enter your full name';
        errEl.style.display = 'block';
        btn.disabled = false;
        btn.textContent = 'Create Account';
        return;
      }
      result = await sb.auth.signUp({
        email, password,
        options: { data: { full_name: name } }
      });
    } else {
      result = await sb.auth.signInWithPassword({ email, password });
    }

    if (result.error) throw result.error;

    if (isSignUp && result.data.user && !result.data.session) {
      errEl.textContent = 'Check your email to confirm your account.';
      errEl.style.display = 'block';
      errEl.style.background = 'var(--green-dim)';
      errEl.style.color = 'var(--green)';
      btn.disabled = false;
      btn.textContent = 'Create Account';
      return;
    }

    currentUser = result.data.user;
    await loadProfile();
    enterApp();
  } catch (e) {
    errEl.textContent = e.message || 'Authentication failed';
    errEl.style.display = 'block';
  }

  btn.disabled = false;
  btn.textContent = isSignUp ? 'Create Account' : 'Sign In';
}

async function loadProfile() {
  // Upsert profile on login
  const { data } = await sb
    .from('profiles')
    .select('*')
    .eq('id', currentUser.id)
    .single();

  if (data) {
    currentProfile = data;
  } else {
    const name = currentUser.user_metadata?.full_name || currentUser.email.split('@')[0];
    const { data: newProfile } = await sb
      .from('profiles')
      .upsert({ id: currentUser.id, full_name: name, role: 'employee', is_approved: false })
      .select()
      .single();
    currentProfile = newProfile;
  }
}

function enterApp() {
  const isApproved = currentProfile?.is_approved === true;
  const isApprover = currentProfile?.role === 'approver';

  // Approvers are always considered approved
  if (!isApproved && !isApprover) {
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('pendingScreen').classList.add('active');
    document.getElementById('pendingEmail').textContent = currentUser.email;
    return;
  }

  document.getElementById('loginScreen').classList.add('hidden');
  document.getElementById('pendingScreen').classList.remove('active');
  document.getElementById('app').classList.add('active');

  document.getElementById('userRole').textContent = isApprover ? 'Approver' : 'Employee';
  document.getElementById('navApprovals').style.display = isApprover ? 'flex' : 'none';
  document.getElementById('navUsers').style.display = isApprover ? 'flex' : 'none';

  addLineItem();
  loadMyPOs();
  if (isApprover) {
    loadApprovals();
    loadUsers();
  }
}

async function logout() {
  await sb.auth.signOut();
  document.getElementById('app').classList.remove('active');
  document.getElementById('pendingScreen').classList.remove('active');
  document.getElementById('loginScreen').classList.remove('hidden');
  currentUser = null;
  currentProfile = null;
}

// ‚îÄ‚îÄ‚îÄ CHECK SESSION ON LOAD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function checkSession() {
  if (!initSupabase()) return;
  const { data: { session } } = await sb.auth.getSession();
  if (session) {
    currentUser = session.user;
    await loadProfile();
    enterApp();
  }
}

// ‚îÄ‚îÄ‚îÄ NAVIGATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showPage(pageId, navEl) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById(pageId).classList.add('active');
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  navEl.classList.add('active');

  if (pageId === 'pageMyPOs') loadMyPOs();
  if (pageId === 'pageApprovals') loadApprovals();
  if (pageId === 'pageUsers') loadUsers();
}

// ‚îÄ‚îÄ‚îÄ LINE ITEMS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let lineItemCount = 0;

function addLineItem() {
  lineItemCount++;
  const container = document.getElementById('lineItems');
  const div = document.createElement('div');
  div.className = 'line-item';
  div.id = `lineItem_${lineItemCount}`;
  div.innerHTML = `
    <div class="line-item-header">
      <span class="line-item-num">ITEM #${lineItemCount}</span>
      <button class="remove-item" onclick="removeLineItem('lineItem_${lineItemCount}')" title="Remove">√ó</button>
    </div>
    <div class="field">
      <label>Description</label>
      <input type="text" class="item-desc" placeholder="e.g. Printer Toner Cartridge">
    </div>
    <div class="cost-row">
      <div class="field">
        <label>Qty</label>
        <input type="number" class="item-qty" value="1" min="1" oninput="updateTotal()">
      </div>
      <div class="field">
        <label>Est. Unit Cost ($)</label>
        <input type="number" class="item-cost" placeholder="0.00" step="0.01" min="0" oninput="updateTotal()">
      </div>
    </div>
  `;
  container.appendChild(div);
  updateTotal();
}

function removeLineItem(id) {
  const el = document.getElementById(id);
  if (el && document.querySelectorAll('.line-item').length > 1) {
    el.remove();
    updateTotal();
  }
}

function updateTotal() {
  let total = 0;
  document.querySelectorAll('.line-item').forEach(item => {
    const qty = parseFloat(item.querySelector('.item-qty')?.value) || 0;
    const cost = parseFloat(item.querySelector('.item-cost')?.value) || 0;
    total += qty * cost;
  });
  document.getElementById('totalAmount').textContent = '$' + total.toFixed(2);
}

// ‚îÄ‚îÄ‚îÄ SUBMIT PO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function submitPO() {
  const vendor = document.getElementById('vendorName').value.trim();
  const poFor = document.getElementById('poFor').value.trim();
  const notes = document.getElementById('poNotes').value.trim();

  if (!vendor) {
    showToast('Please enter a vendor name', 'error');
    return;
  }

  if (!poFor) {
    showToast('Please specify what this PO is for (vehicle, tractor, shop, etc.)', 'error');
    return;
  }

  const items = [];
  let valid = true;
  document.querySelectorAll('.line-item').forEach(item => {
    const desc = item.querySelector('.item-desc').value.trim();
    const qty = parseFloat(item.querySelector('.item-qty').value) || 0;
    const cost = parseFloat(item.querySelector('.item-cost').value) || 0;
    if (!desc || qty <= 0 || cost <= 0) valid = false;
    items.push({ description: desc, quantity: qty, unit_cost: cost, line_total: qty * cost });
  });

  if (!valid || items.length === 0) {
    showToast('Fill in all item details (description, qty, cost)', 'error');
    return;
  }

  const total = items.reduce((s, i) => s + i.line_total, 0);

  try {
    const { data: po, error } = await sb
      .from('purchase_orders')
      .insert({
        requester_id: currentUser.id,
        requester_name: currentProfile.full_name,
        vendor_name: vendor,
        po_for: poFor,
        notes: notes,
        items: items,
        estimated_total: total,
        status: 'requested'
      })
      .select()
      .single();

    if (error) throw error;

    showToast('Purchase order submitted!', 'success');
    // Reset form
    document.getElementById('vendorName').value = '';
    document.getElementById('poFor').value = '';
    document.getElementById('poNotes').value = '';
    document.getElementById('lineItems').innerHTML = '';
    lineItemCount = 0;
    addLineItem();
  } catch (e) {
    showToast('Failed to submit: ' + e.message, 'error');
  }
}

// ‚îÄ‚îÄ‚îÄ LOAD MY POs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let myPOFilter = 'all';

async function loadMyPOs() {
  const container = document.getElementById('myPOList');
  container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

  let query = sb
    .from('purchase_orders')
    .select('*')
    .eq('requester_id', currentUser.id)
    .order('created_at', { ascending: false });

  if (myPOFilter !== 'all') query = query.eq('status', myPOFilter);

  const { data, error } = await query;

  if (error) {
    container.innerHTML = `<div class="empty-state"><div class="empty-text">Error loading orders</div><div class="empty-sub">${error.message}</div></div>`;
    return;
  }

  if (!data || data.length === 0) {
    container.innerHTML = `<div class="empty-state"><div class="empty-icon">üìã</div><div class="empty-text">No purchase orders</div><div class="empty-sub">Create your first request from the New tab</div></div>`;
    return;
  }

  container.innerHTML = data.map(po => poCardHTML(po)).join('');
}

function filterPOs(filter, btn) {
  myPOFilter = filter;
  document.querySelectorAll('#pageMyPOs .filter-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  loadMyPOs();
}

// ‚îÄ‚îÄ‚îÄ LOAD APPROVALS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let approvalFilter = 'requested';

async function loadApprovals() {
  const container = document.getElementById('approvalList');
  container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

  let query = sb
    .from('purchase_orders')
    .select('*')
    .order('created_at', { ascending: false });

  if (approvalFilter === 'requested') query = query.eq('status', 'requested');

  const { data, error } = await query;

  if (error) {
    container.innerHTML = `<div class="empty-state"><div class="empty-text">Error</div><div class="empty-sub">${error.message}</div></div>`;
    return;
  }

  // Update badge
  const requestedCount = data ? data.filter(po => po.status === 'requested').length : 0;
  const badge = document.getElementById('approvalBadge');
  if (requestedCount > 0) {
    badge.textContent = requestedCount;
    badge.style.display = 'flex';
  } else {
    badge.style.display = 'none';
  }

  if (!data || data.length === 0) {
    container.innerHTML = `<div class="empty-state"><div class="empty-icon">‚úì</div><div class="empty-text">No ${approvalFilter === 'requested' ? 'pending' : ''} orders</div><div class="empty-sub">All caught up!</div></div>`;
    return;
  }

  container.innerHTML = data.map(po => poCardHTML(po, true)).join('');
}

function filterApprovals(filter, btn) {
  approvalFilter = filter;
  document.querySelectorAll('#pageApprovals .filter-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  loadApprovals();
}

// ‚îÄ‚îÄ‚îÄ PO CARD HTML ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function poCardHTML(po, showRequester = false) {
  const date = new Date(po.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
  const itemCount = po.items?.length || 0;
  return `
    <div class="po-card" onclick='openDetail(${JSON.stringify(po).replace(/'/g, "&#39;")})'>
      <div class="po-card-top">
        <div>
          <div class="po-id">${po.po_number ? po.po_number : 'PO-' + String(po.id).padStart(4, '0')}</div>
          ${showRequester ? `<div class="requester-info">by ${po.requester_name || 'Unknown'}</div>` : ''}
        </div>
        <span class="po-status status-${po.status}">${po.status}</span>
      </div>
      <div class="po-vendor">${escapeHtml(po.vendor_name)}</div>
      ${po.po_for ? `<div style="font-size:12px;color:var(--text-dim);margin-bottom:4px">‚Ü≥ ${escapeHtml(po.po_for)}</div>` : ''}
      <div class="po-meta">
        <span>${itemCount} item${itemCount !== 1 ? 's' : ''} ¬∑ ${date}</span>
        <span class="po-total">$${po.estimated_total.toFixed(2)}</span>
      </div>
    </div>
  `;
}

// ‚îÄ‚îÄ‚îÄ PO DETAIL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openDetail(po) {
  const isApprover = currentProfile?.role === 'approver';
  const isRequested = po.status === 'requested';
  const date = new Date(po.created_at).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });
  const reviewDate = po.reviewed_at ? new Date(po.reviewed_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : '';

  // Build process flow stepper
  const flowClass = po.status === 'approved' ? 'flow-approved' : po.status === 'rejected' ? 'flow-rejected' : 'flow-requested';

  let stepRequestedClass = 'step-active';
  let stepRequestedIcon = '‚óè';
  let stepApprovedClass = '';
  let stepApprovedIcon = '2';
  let stepRejectedClass = '';
  let stepRejectedIcon = '3';

  if (po.status === 'approved') {
    stepRequestedClass = 'step-done';
    stepRequestedIcon = '‚úì';
    stepApprovedClass = 'step-done';
    stepApprovedIcon = '‚úì';
  } else if (po.status === 'rejected') {
    stepRequestedClass = 'step-done';
    stepRequestedIcon = '‚úì';
    stepRejectedClass = 'step-rejected';
    stepRejectedIcon = '‚úï';
  }

  const processFlowHTML = `
    <div class="process-flow ${flowClass}">
      <div class="process-step ${stepRequestedClass}">
        <div class="step-circle">${stepRequestedIcon}</div>
        <div class="step-label">Requested</div>
        <div class="step-date">${new Date(po.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</div>
      </div>
      <div class="process-step ${po.status === 'approved' ? stepApprovedClass : (po.status === 'rejected' ? '' : '')}">
        <div class="step-circle">${po.status === 'approved' ? stepApprovedIcon : '2'}</div>
        <div class="step-label">Approved</div>
        ${po.status === 'approved' && reviewDate ? `<div class="step-date">${reviewDate}</div>` : '<div class="step-date">‚Äî</div>'}
      </div>
      <div class="process-step ${stepRejectedClass}">
        <div class="step-circle">${po.status === 'rejected' ? stepRejectedIcon : '‚Äî'}</div>
        <div class="step-label">Rejected</div>
        ${po.status === 'rejected' && reviewDate ? `<div class="step-date">${reviewDate}</div>` : '<div class="step-date">‚Äî</div>'}
      </div>
    </div>
  `;

  let itemsHTML = (po.items || []).map(item => `
    <div class="detail-item">
      <div class="detail-item-name">${escapeHtml(item.description)}</div>
      <div class="detail-item-meta">
        <span>Qty: ${item.quantity}</span>
        <span>$${item.unit_cost.toFixed(2)} ea ‚Üí $${item.line_total.toFixed(2)}</span>
      </div>
    </div>
  `).join('');

  document.getElementById('modalContent').innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div class="modal-title">${po.po_number ? po.po_number : 'PO-' + String(po.id).padStart(4, '0')}</div>
      <span class="po-status status-${po.status}">${po.status}</span>
    </div>

    ${processFlowHTML}

    <div class="detail-section">
      <div class="detail-row"><span class="detail-label">Vendor</span><span class="detail-value">${escapeHtml(po.vendor_name)}</span></div>
      <div class="detail-row"><span class="detail-label">For</span><span class="detail-value">${escapeHtml(po.po_for || '‚Äî')}</span></div>
      <div class="detail-row"><span class="detail-label">Requested By</span><span class="detail-value">${escapeHtml(po.requester_name || 'Unknown')}</span></div>
      <div class="detail-row"><span class="detail-label">Date</span><span class="detail-value">${date}</span></div>
      <div class="detail-row"><span class="detail-label">Est. Total</span><span class="detail-value" style="color:var(--accent);font-family:var(--mono)">$${po.estimated_total.toFixed(2)}</span></div>
      ${po.notes ? `<div class="detail-row"><span class="detail-label">Notes</span><span class="detail-value" style="max-width:60%;text-align:right">${escapeHtml(po.notes)}</span></div>` : ''}
      ${po.reviewed_by_name ? `<div class="detail-row"><span class="detail-label">${po.status === 'approved' ? 'Approved' : 'Rejected'} By</span><span class="detail-value">${escapeHtml(po.reviewed_by_name)}</span></div>` : ''}
    </div>

    <div class="detail-section">
      <div class="section-title" style="border:none;padding:0;margin-bottom:10px">Items (${po.items?.length || 0})</div>
      ${itemsHTML}
    </div>

    ${isApprover && isRequested ? `
      <div class="approval-actions">
        <button class="btn btn-approve" onclick="reviewPO(${po.id}, 'approved')">‚úì Approve</button>
        <button class="btn btn-reject" onclick="reviewPO(${po.id}, 'rejected')">‚úï Reject</button>
      </div>
    ` : ''}

    ${isApprover ? `
      <div class="approver-toolbar">
        <button class="btn btn-edit" onclick="openEditMode(${po.id})">‚úé Edit</button>
        <button class="btn btn-delete" onclick="promptDeletePO(${po.id}, '${po.po_number ? escapeHtml(po.po_number) : 'PO-' + String(po.id).padStart(4, '0')}')">üóë Delete</button>
      </div>
    ` : ''}
  `;

  currentDetailPO = po;
  document.getElementById('detailModal').classList.add('active');
}

function closeModal() {
  document.getElementById('detailModal').classList.remove('active');
}

// ‚îÄ‚îÄ‚îÄ APPROVE / REJECT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function reviewPO(poId, status) {
  try {
    let updateData = {
      status: status,
      reviewed_by: currentUser.id,
      reviewed_by_name: currentProfile.full_name,
      reviewed_at: new Date().toISOString()
    };

    // Auto-generate PO# on approval
    if (status === 'approved') {
      // Get next sequential number
      const { data: maxPO } = await sb
        .from('purchase_orders')
        .select('po_sequence')
        .not('po_sequence', 'is', null)
        .order('po_sequence', { ascending: false })
        .limit(1)
        .single();

      const nextSeq = (maxPO?.po_sequence || 0) + 1;

      // Get YYDD (2-digit year + 2-digit day)
      const now = new Date();
      const yy = String(now.getFullYear()).slice(-2);
      const dd = String(now.getDate()).padStart(2, '0');
      const datePart = yy + dd;

      // Get requester initials from the PO's requester_name
      const { data: poData } = await sb
        .from('purchase_orders')
        .select('requester_name')
        .eq('id', poId)
        .single();

      const nameParts = (poData?.requester_name || '').trim().split(/\s+/);
      const initials = nameParts.length >= 2
        ? (nameParts[0][0] + nameParts[nameParts.length - 1][0]).toUpperCase()
        : (nameParts[0] || 'XX').slice(0, 2).toUpperCase();

      const poNumber = `${String(nextSeq).padStart(4, '0')}-${datePart}-${initials}`;

      updateData.po_sequence = nextSeq;
      updateData.po_number = poNumber;
    }

    const { error } = await sb
      .from('purchase_orders')
      .update(updateData)
      .eq('id', poId);

    if (error) throw error;

    showToast(status === 'approved'
      ? `Approved! PO# ${updateData.po_number}`
      : 'Purchase order rejected', status === 'approved' ? 'success' : 'error');
    closeModal();
    loadApprovals();
  } catch (e) {
    showToast('Failed: ' + e.message, 'error');
  }
}

// ‚îÄ‚îÄ‚îÄ USER MANAGEMENT (APPROVERS ONLY) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let userFilter = 'pending';

async function loadUsers() {
  const container = document.getElementById('userList');
  if (!container) return;
  container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

  let query = sb
    .from('profiles')
    .select('*')
    .order('created_at', { ascending: false });

  if (userFilter === 'pending') query = query.eq('is_approved', false);
  if (userFilter === 'approved') query = query.eq('is_approved', true);

  const { data, error } = await query;

  if (error) {
    container.innerHTML = `<div class="empty-state"><div class="empty-text">Error</div><div class="empty-sub">${error.message}</div></div>`;
    return;
  }

  // Update badge with pending count
  const { data: pendingData } = await sb
    .from('profiles')
    .select('id')
    .eq('is_approved', false);

  const pendingCount = pendingData ? pendingData.filter(p => p.id !== currentUser.id).length : 0;
  const badge = document.getElementById('usersBadge');
  if (pendingCount > 0) {
    badge.textContent = pendingCount;
    badge.style.display = 'flex';
  } else {
    badge.style.display = 'none';
  }

  // Filter out current user from display if they're an approver (they don't need to approve themselves)
  const filteredData = data ? data.filter(u => {
    // For pending filter, don't show approvers (they're auto-approved)
    if (userFilter === 'pending' && u.role === 'approver') return false;
    return true;
  }) : [];

  if (filteredData.length === 0) {
    container.innerHTML = `<div class="empty-state"><div class="empty-icon">üë•</div><div class="empty-text">No ${userFilter === 'pending' ? 'pending' : userFilter === 'approved' ? 'approved' : ''} users</div><div class="empty-sub">${userFilter === 'pending' ? 'No accounts waiting for approval' : 'No users found'}</div></div>`;
    return;
  }

  container.innerHTML = filteredData.map(user => userCardHTML(user)).join('');
}

function filterUsers(filter, btn) {
  userFilter = filter;
  document.querySelectorAll('#pageUsers .filter-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  loadUsers();
}

function userCardHTML(user) {
  const isSelf = user.id === currentUser.id;
  const isApproved = user.is_approved === true;
  const isApproverRole = user.role === 'approver';

  let actionsHTML = '';
  if (!isSelf) {
    if (!isApproved && !isApproverRole) {
      actionsHTML = `
        <button class="btn btn-approve btn-sm" onclick="approveUser('${user.id}')">Approve</button>
        <button class="btn btn-reject btn-sm" onclick="removeUser('${user.id}', '${escapeHtml(user.full_name)}')">Deny</button>
      `;
    } else if (isApproved) {
      actionsHTML = `
        <button class="btn btn-secondary btn-sm" onclick="revokeUser('${user.id}')">Revoke</button>
      `;
    }
  }

  return `
    <div class="user-card">
      <div class="user-info">
        <div class="user-name">${escapeHtml(user.full_name)}${isSelf ? ' (you)' : ''}</div>
        <div class="user-badges">
          ${isApproverRole ? '<span class="badge-role">Approver</span>' : '<span class="badge-role">Employee</span>'}
          ${isApproved || isApproverRole ? '<span class="badge-approved">Active</span>' : '<span class="badge-pending-approval">Pending</span>'}
        </div>
      </div>
      <div class="user-actions">
        ${actionsHTML}
      </div>
    </div>
  `;
}

async function approveUser(userId) {
  try {
    const { error } = await sb
      .from('profiles')
      .update({ is_approved: true })
      .eq('id', userId);

    if (error) throw error;
    showToast('User approved', 'success');
    loadUsers();
  } catch (e) {
    showToast('Failed: ' + e.message, 'error');
  }
}

async function revokeUser(userId) {
  try {
    const { error } = await sb
      .from('profiles')
      .update({ is_approved: false })
      .eq('id', userId);

    if (error) throw error;
    showToast('User access revoked', 'success');
    loadUsers();
  } catch (e) {
    showToast('Failed: ' + e.message, 'error');
  }
}

async function removeUser(userId, userName) {
  pendingDeleteId = userId;
  document.getElementById('confirmText').textContent =
    `Deny and remove ${userName}'s account? They will need to sign up again.`;
  document.getElementById('confirmOverlay').classList.add('active');
  // Override the confirm button to call removeUserConfirm
  document.getElementById('confirmDeleteBtn').onclick = async function() {
    try {
      const { error } = await sb
        .from('profiles')
        .delete()
        .eq('id', userId);

      if (error) throw error;
      showToast('User removed', 'success');
      closeConfirm();
      loadUsers();
    } catch (e) {
      showToast('Failed: ' + e.message, 'error');
      closeConfirm();
    }
    // Reset the confirm button back to PO delete
    document.getElementById('confirmDeleteBtn').onclick = confirmDeletePO;
  };
}

// ‚îÄ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let currentDetailPO = null;
let pendingDeleteId = null;

// ‚îÄ‚îÄ‚îÄ EDIT MODE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function openEditMode(poId) {
  // Fetch fresh data
  const { data: po, error } = await sb
    .from('purchase_orders')
    .select('*')
    .eq('id', poId)
    .single();

  if (error || !po) {
    showToast('Failed to load PO for editing', 'error');
    return;
  }

  const items = po.items || [];

  let editItemsHTML = items.map((item, i) => `
    <div class="edit-line-item" data-edit-idx="${i}">
      <div class="field">
        <label>Description</label>
        <input type="text" class="edit-item-desc" value="${escapeHtml(item.description)}">
      </div>
      <div class="cost-row">
        <div class="field">
          <label>Qty</label>
          <input type="number" class="edit-item-qty" value="${item.quantity}" min="1">
        </div>
        <div class="field">
          <label>Unit Cost ($)</label>
          <input type="number" class="edit-item-cost" value="${item.unit_cost}" step="0.01" min="0">
        </div>
      </div>
    </div>
  `).join('');

  document.getElementById('modalContent').innerHTML = `
    <div class="modal-title">Edit ${po.po_number ? po.po_number : 'PO-' + String(po.id).padStart(4, '0')}</div>

    <div class="edit-form">
      <div class="detail-section" style="margin-top:12px; padding-top:12px;">
        <div class="field">
          <label>Vendor / Supplier</label>
          <input type="text" id="editVendor" value="${escapeHtml(po.vendor_name)}">
        </div>
        <div class="field">
          <label>For (Vehicle / Tractor / Shop)</label>
          <input type="text" id="editPoFor" value="${escapeHtml(po.po_for || '')}">
        </div>
        <div class="field">
          <label>Notes</label>
          <textarea id="editNotes">${escapeHtml(po.notes || '')}</textarea>
        </div>
      </div>

      <div class="detail-section">
        <div class="section-title" style="border:none;padding:0;margin-bottom:10px">Items</div>
        <div id="editLineItems">${editItemsHTML}</div>
        <button class="add-item-btn" onclick="addEditLineItem()" style="margin-top:8px">
          <span style="font-size:18px">+</span> Add Item
        </button>
      </div>

      <div class="edit-actions">
        <button class="btn btn-secondary" onclick="openDetail(currentDetailPO)">Cancel</button>
        <button class="btn btn-primary" onclick="saveEdit(${po.id})">Save Changes</button>
      </div>
    </div>
  `;
}

function addEditLineItem() {
  const container = document.getElementById('editLineItems');
  const idx = container.children.length;
  const div = document.createElement('div');
  div.className = 'edit-line-item';
  div.setAttribute('data-edit-idx', idx);
  div.innerHTML = `
    <div class="field">
      <label>Description</label>
      <input type="text" class="edit-item-desc" value="">
    </div>
    <div class="cost-row">
      <div class="field">
        <label>Qty</label>
        <input type="number" class="edit-item-qty" value="1" min="1">
      </div>
      <div class="field">
        <label>Unit Cost ($)</label>
        <input type="number" class="edit-item-cost" value="" step="0.01" min="0">
      </div>
    </div>
  `;
  container.appendChild(div);
}

async function saveEdit(poId) {
  const vendor = document.getElementById('editVendor').value.trim();
  const poFor = document.getElementById('editPoFor').value.trim();
  const notes = document.getElementById('editNotes').value.trim();

  if (!vendor) {
    showToast('Vendor name is required', 'error');
    return;
  }

  const items = [];
  let valid = true;
  document.querySelectorAll('.edit-line-item').forEach(el => {
    const desc = el.querySelector('.edit-item-desc').value.trim();
    const qty = parseFloat(el.querySelector('.edit-item-qty').value) || 0;
    const cost = parseFloat(el.querySelector('.edit-item-cost').value) || 0;
    if (!desc || qty <= 0 || cost <= 0) valid = false;
    items.push({ description: desc, quantity: qty, unit_cost: cost, line_total: qty * cost });
  });

  if (!valid || items.length === 0) {
    showToast('Fill in all item details', 'error');
    return;
  }

  const total = items.reduce((s, i) => s + i.line_total, 0);

  try {
    const { data, error } = await sb
      .from('purchase_orders')
      .update({
        vendor_name: vendor,
        po_for: poFor,
        notes: notes,
        items: items,
        estimated_total: total
      })
      .eq('id', poId)
      .select()
      .single();

    if (error) throw error;

    showToast('Purchase order updated', 'success');
    currentDetailPO = data;
    openDetail(data);
    loadMyPOs();
    if (currentProfile?.role === 'approver') loadApprovals();
  } catch (e) {
    showToast('Failed to save: ' + e.message, 'error');
  }
}

// ‚îÄ‚îÄ‚îÄ DELETE PO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function promptDeletePO(poId, poLabel) {
  pendingDeleteId = poId;
  document.getElementById('confirmText').textContent =
    `This will permanently delete ${poLabel} and all its data. This action cannot be undone.`;
  document.getElementById('confirmOverlay').classList.add('active');
}

function closeConfirm() {
  document.getElementById('confirmOverlay').classList.remove('active');
  pendingDeleteId = null;
}

async function confirmDeletePO() {
  if (!pendingDeleteId) return;
  const poId = pendingDeleteId;

  try {
    const { error } = await sb
      .from('purchase_orders')
      .delete()
      .eq('id', poId);

    if (error) throw error;

    showToast('Purchase order deleted', 'success');
    closeConfirm();
    closeModal();
    loadMyPOs();
    if (currentProfile?.role === 'approver') loadApprovals();
  } catch (e) {
    showToast('Failed to delete: ' + e.message, 'error');
    closeConfirm();
  }
}
function showToast(msg, type = '') {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.className = 'toast ' + type;
  toast.style.display = 'block';
  setTimeout(() => { toast.style.display = 'none'; }, 3000);
}

function escapeHtml(text) {
  const d = document.createElement('div');
  d.textContent = text || '';
  return d.innerHTML;
}

// Init
document.addEventListener('DOMContentLoaded', function() {
  try {
    checkSession();
  } catch(e) {
    console.error('Startup error:', e);
  }
});
</script>
</body>
</html>
